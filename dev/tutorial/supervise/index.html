<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Supervise Actors · Actors.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Actors.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit">Actors.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../install/">Install and Use <code>Actors</code></a></li><li><a class="tocitem" href="../intro/">Getting Started with Actors</a></li><li><a class="tocitem" href="../tabletennis/">Simulate a Game</a></li><li><a class="tocitem" href="../stack/">Implement a Stack</a></li><li><a class="tocitem" href="../dictsrv/">Implement a thread-safe <code>Dict</code></a></li><li class="is-active"><a class="tocitem" href>Supervise Actors</a><ul class="internal"><li><a class="tocitem" href="#Setup-a-supervisor"><span>Setup a supervisor</span></a></li><li><a class="tocitem" href="#Supervise-child-actors"><span>Supervise child actors</span></a></li><li><a class="tocitem" href="#Query-failed-actors"><span>Query failed actors</span></a></li><li><a class="tocitem" href="#Maintain-actor-state-across-restarts"><span>Maintain actor state across restarts</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../howto/spawn/"><code>spawn</code> actors</a></li><li><a class="tocitem" href="../../howto/communicate/">communicate with actors</a></li><li><a class="tocitem" href="../../howto/information/">get information from actors</a></li><li><a class="tocitem" href="../../howto/share/">(not) share variables</a></li><li><a class="tocitem" href="../../howto/failure/">deal with failures</a></li><li><a class="tocitem" href="../../howto/register/"><code>register</code> actors</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">On Actors</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../manual/basics/">Actor Model</a></li><li><a class="tocitem" href="../../manual/actors/">Actors and Julia</a></li><li><a class="tocitem" href="../../manual/behaviors/">Actor Behavior</a></li><li><a class="tocitem" href="../../manual/protocol/">Messaging Protocol</a></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Error Handling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../manual/errors/">Error Handling Overview</a></li><li><a class="tocitem" href="../../manual/connections/">Connections</a></li><li><a class="tocitem" href="../../manual/monitors/">Monitors</a></li><li><a class="tocitem" href="../../manual/supervisors/">Supervisors</a></li><li><a class="tocitem" href="../../manual/node_failures/">Node Failures</a></li><li><a class="tocitem" href="../../manual/checkpoints/">Checkpointing</a></li><li><a class="tocitem" href="../../manual/fault_tolerance/">Fault Tolerance</a></li></ul></li><li><a class="tocitem" href="../../manual/infrastructure/">More Useful Stuff</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-5-1" type="checkbox"/><label class="tocitem" for="menuitem-5-1"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/api/"><code>Actors</code> Module</a></li><li><a class="tocitem" href="../../api/types/">Basic Types</a></li><li><a class="tocitem" href="../../api/starting/">Starting Actors, creating links</a></li><li><a class="tocitem" href="../../api/primitives/">Actor Primitives</a></li><li><a class="tocitem" href="../../api/comm/">Communication primitives</a></li><li><a class="tocitem" href="../../api/user_api/">User API</a></li><li><a class="tocitem" href="../../api/registry/">Actor Registry</a></li><li><a class="tocitem" href="../../api/connect/">Connections</a></li><li><a class="tocitem" href="../../api/monitor/">Monitors</a></li><li><a class="tocitem" href="../../api/supervision/">Supervisors</a></li><li><a class="tocitem" href="../../api/checkpointing/">Checkpointing</a></li><li><a class="tocitem" href="../../api/utils/">Utilities</a></li><li><a class="tocitem" href="../../api/diagnosis/">Diagnosis</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/dining_phil/">Dining Philosophers</a></li><li><a class="tocitem" href="../../examples/prod_cons/">Producer-Consumer Problem</a></li><li><a class="tocitem" href="../../examples/examples/">Further Examples</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../reference/diag/">Diagnostics</a></li><li><a class="tocitem" href="../../reference/internals/">Internals</a></li><li><a class="tocitem" href="../../reference/messages/">Messages</a></li><li><a class="tocitem" href="../../reference/interface/">Interface</a></li></ul></li><li><a class="tocitem" href="../../reference/glossary/">A Glossary of Actor Terms</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Supervise Actors</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Supervise Actors</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaActors/Actors.jl/blob/master/docs/src/tutorial/supervise.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Supervise-Actors"><a class="docs-heading-anchor" href="#Supervise-Actors">Supervise Actors</a><a id="Supervise-Actors-1"></a><a class="docs-heading-anchor-permalink" href="#Supervise-Actors" title="Permalink"></a></h1><p>A supervisor is an actor looking after child actors and restarting them as necessary when they exit.</p><h2 id="Setup-a-supervisor"><a class="docs-heading-anchor" href="#Setup-a-supervisor">Setup a supervisor</a><a id="Setup-a-supervisor-1"></a><a class="docs-heading-anchor-permalink" href="#Setup-a-supervisor" title="Permalink"></a></h2><p>We setup a <a href="../../api/supervision/#Actors.supervisor"><code>supervisor</code></a> <code>A10</code> with the default <a href="../../api/supervision/#strategies">supervision strategy</a> <code>:one_by_one</code>:</p><pre><code class="language-julia">julia&gt; using Actor, .Threads

julia&gt; import Actors: spawn

julia&gt; A10 = supervisor()
Link{Channel{Any}}(Channel{Any}(32), 1, :supervisor)</code></pre><h2 id="Supervise-child-actors"><a class="docs-heading-anchor" href="#Supervise-child-actors">Supervise child actors</a><a id="Supervise-child-actors-1"></a><a class="docs-heading-anchor-permalink" href="#Supervise-child-actors" title="Permalink"></a></h2><p>We start six actors <code>A1</code>-<code>A6</code> and <a href="../../api/supervision/#Actors.supervise"><code>supervise</code></a> them with <code>A10</code> with default <a href="../../api/supervision/#restart">restart arguments</a>. If they fail, they will be restarted with their <code>threadid</code> behavior and  are assumed to be <code>:transient</code> (they get restarted if they terminate abnormally).</p><pre><code class="language-julia">julia&gt; A = map(_-&gt;spawn(threadid), 1:6);    # spawn A1 - A6

julia&gt; t = map(a-&gt;Actors.diag(a, :task), A) # A1 - A6 are running
6-element Vector{Task}:
 Task (runnable) @0x000000016e948560
 Task (runnable) @0x000000016e949660
 Task (runnable) @0x000000016e949880
 Task (runnable) @0x000000016e949bb0
 Task (runnable) @0x000000016e949ee0
 Task (runnable) @0x000000016e94a100

julia&gt; foreach(a-&gt;exec(a, supervise, A10), A)</code></pre><p><strong>One for one</strong>: With the default supervision strategy <code>:one_for_one</code> the supervisor restarts a single actor when it fails:</p><pre><code class="language-julia">julia&gt; send(A[4], :boom);                   # let A4 fail
┌ Warning: 2021-02-13 12:55:27 x-d-kuhub-dabab: Exit: supervised Task (failed) @0x000000016e949bb0, MethodError(Base.Threads.threadid, (:boom,), 0x0000000000007458)
└ @ Actors ~/.julia/dev/Actors/src/logging.jl:31
┌ Warning: 2021-02-13 12:55:27 x-d-kuhub-dabab: supervisor: restarting
└ @ Actors ~/.julia/dev/Actors/src/logging.jl:31

julia&gt; t = map(a-&gt;Actors.diag(a, :task), A) # look at the tasks
6-element Vector{Task}:
 Task (runnable) @0x000000016e948560
 Task (runnable) @0x000000016e949660
 Task (runnable) @0x000000016e949880
 Task (runnable) @0x000000010e3b8230
 Task (runnable) @0x000000016e949ee0
 Task (runnable) @0x000000016e94a100</code></pre><p>A1-A6 have all runnable tasks, but A4 has been restarted.</p><p><strong>One for all</strong>: With the second strategy <code>:one_for_all</code>, all supervised actors/tasks get restarted if one of them fails. That allows to restart a group of equitable actors depending on each other. Normally we would choose the strategy at supervisor start, but now we change the supervision strategy of the running supervisor A10 and let A4 fail again:</p><pre><code class="language-julia">julia&gt; set_strategy(A10, :one_for_all)      # change restart strategy
(Actors.Strategy(:one_for_all),)

julia&gt; send(A[4], :boom);                   # let A4 fail again
┌ Warning: 2021-02-13 12:57:16 x-d-kuhub-dabab: Exit: supervised Task (failed) @0x000000010e3b8230, MethodError(Base.Threads.threadid, (:boom,), 0x0000000000007459)
└ @ Actors ~/.julia/dev/Actors/src/logging.jl:31
┌ Warning: 2021-02-13 12:57:16 x-d-kuhub-dabab: supervisor: restarting all
└ @ Actors ~/.julia/dev/Actors/src/logging.jl:31

julia&gt; t = map(a-&gt;Actors.diag(a, :task), A)
6-element Vector{Task}:
 Task (runnable) @0x000000010e3b8450
 Task (runnable) @0x000000010e3b8670
 Task (runnable) @0x000000010e3b8890
 Task (runnable) @0x000000010e3b8ab0
 Task (runnable) @0x000000010e3b8cd0
 Task (runnable) @0x000000010e3b9000</code></pre><p>All actors have been restarted (got new tasks).</p><p><strong>Rest for one</strong>: With <code>:rest_for_one</code> only the failed actor and the actors that registered for supervision after it are restarted. That allows to restart a failed actor and only those other actors depending on it. Again we change A10&#39;s strategy and let A4 fail:</p><pre><code class="language-julia">julia&gt; set_strategy(A10, :rest_for_one)     # change strategy again
(Actors.Strategy(:rest_for_one),)

julia&gt; send(A[4], :boom);                   # let A4 fail
┌ Warning: 2021-02-13 12:58:33 x-d-kuhub-dabab: Exit: supervised Task (failed) @0x000000010e3b8ab0, MethodError(Base.Threads.threadid, (:boom,), 0x000000000000745a)
└ @ Actors ~/.julia/dev/Actors/src/logging.jl:31
┌ Warning: 2021-02-13 12:58:33 x-d-kuhub-dabab: supervisor: restarting rest
└ @ Actors ~/.julia/dev/Actors/src/logging.jl:31

julia&gt; t = map(a-&gt;Actors.diag(a, :task), A)
6-element Vector{Task}:
 Task (runnable) @0x000000010e3b8450
 Task (runnable) @0x000000010e3b8670
 Task (runnable) @0x000000010e3b8890
 Task (runnable) @0x000000010e3b9220
 Task (runnable) @0x000000010e3b9440
 Task (runnable) @0x000000010e3b9770</code></pre><p>Now A4 - A6 have been restarted.</p><h3 id="Further-options"><a class="docs-heading-anchor" href="#Further-options">Further options</a><a id="Further-options-1"></a><a class="docs-heading-anchor-permalink" href="#Further-options" title="Permalink"></a></h3><p>With further <a href="../../api/supervision/#Actors.supervisor"><code>supervisor</code></a> options we can limit how often a supervisor tries to restart children in a given timeframe. If it exceeds this limit, it terminates itself and all of its children with a warning.</p><h2 id="Query-failed-actors"><a class="docs-heading-anchor" href="#Query-failed-actors">Query failed actors</a><a id="Query-failed-actors-1"></a><a class="docs-heading-anchor-permalink" href="#Query-failed-actors" title="Permalink"></a></h2><p>For all failures we got warnings, but we can query the last failures from the supervisor and get more information about them:</p><pre><code class="language-julia">julia&gt; failed = Actors.diag(A10, :err)      # the three failed tasks can be queried from the supervisor
3-element Vector{Task}:
 Task (failed) @0x000000016e949bb0
 Task (failed) @0x000000010e3b8230
 Task (failed) @0x000000010e3b8ab0

julia&gt; failed[1]                            # exceptions and stacktraces are available
Task (failed) @0x000000016e949bb0
MethodError: no method matching threadid(::Symbol)
....</code></pre><h2 id="Maintain-actor-state-across-restarts"><a class="docs-heading-anchor" href="#Maintain-actor-state-across-restarts">Maintain actor state across restarts</a><a id="Maintain-actor-state-across-restarts-1"></a><a class="docs-heading-anchor-permalink" href="#Maintain-actor-state-across-restarts" title="Permalink"></a></h2><p>By default a supervisor restarts an actor with the behavior it had before exiting. An actor thus maintains its state over a restart:</p><pre><code class="language-julia">julia&gt; sv = supervisor()
Link{Channel{Any}}(Channel{Any}(32), 1, :supervisor)

julia&gt; incr(xr, by=0) = xr[] += by        # define an accumulator
incr (generic function with 2 methods)

julia&gt; myactor = spawn(incr, Ref(10))     # start an actor accumulating from 10
Link{Channel{Any}}(Channel{Any}(32), 1, :default)

julia&gt; exec(myactor, supervise, sv);      # put it under supervision

julia&gt; foreach(x-&gt;call(myactor, x), 1:10) # accumulate it

julia&gt; call(myactor)
65

julia&gt; send(myactor, :boom);              # let it fail
┌ Warning: 2021-04-19 17:00:17 x-d-kolok-ib Exit: supervised Task (failed) @0x000000016b9d4010, MethodError(+, (65, :boom), 0x00000000000074aa)
└ @ Actors ~/.julia/dev/Actors/src/logging.jl:39
┌ Warning: 2021-04-19 17:00:17 x-d-kolok-ib supervisor: restarting
└ @ Actors ~/.julia/dev/Actors/src/logging.jl:39

julia&gt; call(myactor)
65

julia&gt; info(myactor)
Actor    default
Behavior incr
Pid      1, Thread 1
Task     @0x000000016da2ba80
Ident    x-d-kukof-ropab</code></pre><p><code>myactor</code> has maintained its state over failure even if it got a new task.</p><div class="admonition is-info"><header class="admonition-header">Actor state recovery after node failures is different!</header><div class="admonition-body"><p>In case of a <a href="../../manual/node_failures/">node failure</a> an actor cannot send its state at failure time to the supervisor. In those cases you can use termination and restart callbacks and <a href="../../manual/checkpoints/">checkpointing</a> for recovery.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../dictsrv/">« Implement a thread-safe <code>Dict</code></a><a class="docs-footer-nextpage" href="../../howto/spawn/"><code>spawn</code> actors »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 28 April 2021 14:28">Wednesday 28 April 2021</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
